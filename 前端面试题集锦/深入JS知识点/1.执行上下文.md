# ä¸€ã€æ‰§è¡Œä¸Šä¸‹æ–‡

## 1ã€è®¤è¯†æ‰§è¡Œä¸Šä¸‹æ–‡

1. å½“ js æ‰§è¡Œåˆ°ä¸€ä¸ªå‡½æ•°æ—¶,å°±ä¼šè¿›è¡Œâ€˜å‡†å¤‡å·¥ä½œâ€˜,å³æ‰§è¡Œä¸Šä¸‹æ–‡
2. è¿è¡Œè§„åˆ™:å½“æ‰§è¡Œä¸€ä¸ªå‡½æ•°æ—¶,å°±ä¼šåˆ›å»ºä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡,å¹¶ä¸” push åˆ°ä¸Šä¸‹æ–‡æ ˆä¸­;å½“å‡½æ•°æ‰§è¡Œå®Œ,å°±ä¼šä»æ ˆä¸­ pop å‡ºå»;
3. ç¤ºä¾‹:

```js
function fun3() {
  console.log('fun3');
}

function fun2() {
  fun3();
}

function fun1() {
  fun2();
}

fun1();
```

4. è§£æ:
   ä¸Šä¸‹æ–‡æ ˆ(Execution context stack)ç”¨ ECStack æ•°ç»„è¡¨ç¤º.

```ts
// ä¼ªä»£ç 

// fun1()  å½“jsæ‰§è¡Œfun1å‡½æ•°æ—¶,ä¼špushåˆ°ä¸Šä¸‹æ–‡æ ˆä¸­;
ECStack.push(<fun1>functionContext);

// fun1ä¸­ç«Ÿç„¶è°ƒç”¨äº†fun2ï¼Œè¿˜è¦åˆ›å»ºfun2çš„æ‰§è¡Œä¸Šä¸‹æ–‡
ECStack.push(<fun2>functionContext);

// æ“¦ï¼Œfun2è¿˜è°ƒç”¨äº†fun3ï¼
ECStack.push(<fun3>functionContext);

// fun3æ‰§è¡Œå®Œæ¯•
ECStack.pop();

// fun2æ‰§è¡Œå®Œæ¯•
ECStack.pop();

// fun1æ‰§è¡Œå®Œæ¯•
ECStack.pop();
```

5. æ¯ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡,åŒ…å«ä¸‰ä¸ªé‡è¦å±æ€§:

- å˜é‡å¯¹è±¡(Variabe Object)
- ä½œç”¨åŸŸ(Scope chain)
- this

---

## 2ã€æ‰§è¡Œä¸Šä¸‹æ–‡ä¹‹å˜é‡å¯¹è±¡

### 2.1 å…¨å±€ä¸Šä¸‹æ–‡

åœ¨ js ä¸­,å…¨å±€å¯¹è±¡å°±æ˜¯ window å¯¹è±¡.å¦‚:

```js
var a = 1;
console.log(window.a, this.a, this.window.a); //1 1 1
```

### 2.2 å‡½æ•°ä¸Šä¸‹æ–‡

- æ³¨æ„:å‡½æ•°ä¸Šä¸‹æ–‡çš„å˜é‡å¯¹è±¡åˆå§‹åŒ–åªåŒ…æ‹¬ Arguments å¯¹è±¡

### æ‰§è¡Œè¿‡ç¨‹ : æ‰§è¡Œä¸Šä¸‹æ–‡çš„æ‰§è¡Œè¿‡ç¨‹åˆ†ä¸¤ä¸ªé˜¶æ®µ:åˆ†æ(è¿›å…¥æ‰§è¡Œä¸Šä¸‹æ–‡)å’Œæ‰§è¡Œ(ä»£ç æ‰§è¡Œ)

1. è¿›å…¥æ‰§è¡Œä¸Šä¸‹æ–‡(å³å˜é‡æå‡)

```js
function foo(a) {
  var b = 2;
  function c() {}
  var d = function() {};

  b = 3;
}

foo(1);
```

- è§£æ:
  è¿›å…¥æ‰§è¡Œä¸Šä¸‹æ–‡å,è¿›è¡Œå˜é‡æå‡,æ­¤æ—¶:

```js
AO = {
    arguments: {
        0: 1,
        length: 1
    },
    a: 1,
    b: undefined,
    c: reference to function c(){},
    d: undefined
}
```

2. ä»£ç æ‰§è¡Œ
   å½“ä¸Šé¢çš„ä¾‹å­æ‰§è¡Œå®Œä¹‹å,å˜é‡å¦‚ä¸‹å˜åŒ–:

```js
AO = {
    arguments: {
        0: 1,
        length: 1
    },
    a: 1,
    b: 3,
    c: reference to function c(){},
    d: reference to FunctionExpression "d"
}

```

- ç»ƒä¹ 

```js
/* ç¬¬ä¸€é¢˜ */
function foo() {
  console.log(a);
  a = 1;
}
// æ³¨æ„:æ­¤æ—¶å¹¶ä¸æ˜¯æŠ¥undefined,è€Œæ˜¯æŠ¥é”™ Uncaught ReferenceError: a is not defined

/* ç¬¬äºŒé¢˜ */
console.log(foo);
function foo() {
  console.log('foo');
}

var foo = 1;
// æ³¨æ„: æ‰§è¡Œå®Œä¸Šä¸‹æ–‡,æ‰“å°çš„æ˜¯å‡½æ•°,è€Œä¸æ˜¯undefined.
// è¿™æ˜¯å› ä¸ºåœ¨æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­,ä¼˜å…ˆä¼šå¤„ç†å‡½æ•°å£°æ˜,å†å¤„ç†å˜é‡å£°æ˜;å¦‚æœå˜é‡å£°æ˜å’Œå‡½æ•°å£°æ˜å‘½åç›¸åŒ,åˆ™ä¼šä¿ç•™å‡½æ•°å£°æ˜çš„å€¼
```

---

## 3ã€æ‰§è¡Œä¸Šä¸‹æ–‡ä¹‹ä½œç”¨åŸŸé“¾

- å®šä¹‰:å½“æŸ¥æ‰¾å˜é‡çš„æ—¶å€™ï¼Œä¼šå…ˆä»å½“å‰ä¸Šä¸‹æ–‡çš„å˜é‡å¯¹è±¡ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±ä¼šä»çˆ¶çº§(è¯æ³•å±‚é¢ä¸Šçš„çˆ¶çº§)æ‰§è¡Œä¸Šä¸‹æ–‡çš„å˜é‡å¯¹è±¡ä¸­æŸ¥æ‰¾ï¼Œä¸€ç›´æ‰¾åˆ°å…¨å±€ä¸Šä¸‹æ–‡çš„å˜é‡å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å…¨å±€å¯¹è±¡ã€‚è¿™æ ·ç”±å¤šä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡çš„å˜é‡å¯¹è±¡æ„æˆçš„é“¾è¡¨å°±å«åšä½œç”¨åŸŸé“¾ã€‚
  æ³¨æ„:è¯æ³•ä½œç”¨åŸŸæ˜¯åœ¨å®šä¹‰æ—¶å°±ç¡®å®šäº†çš„,è€Œä½œç”¨åŸŸé“¾æ˜¯æ ¹æ®è¿è¡Œæ—¶è°ƒç”¨æ ˆè€Œå®šçš„

---

## 4ã€this

- å‰æçŸ¥è¯†:ES5(ECMAScript5)ç±»å‹åˆ†ä¸ºè¯­è¨€ç±»å‹å’Œè§„èŒƒç±»å‹, è¯­è¨€ç±»å‹å°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ Undefinedã€Nullã€Booleanã€Stringã€Numberã€Object ; è§„èŒƒç±»å‹å…¶ä¸­æœ‰ä¸€ä¸ªå«åš Reference ç±»å‹,å¼•ç”¨å°¤é›¨æºªå¤§å¤§çš„è¯:
  > Reference æ˜¯ä¸€ä¸ª Specification Typeï¼Œä¹Ÿå°±æ˜¯ â€œåªå­˜åœ¨äºè§„èŒƒé‡Œçš„æŠ½è±¡ç±»å‹â€

### 4.1 Reference çš„æ„æˆï¼Œç”±ä¸‰ä¸ªç»„æˆéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ï¼š

1. base value
2. referenced name
3. strict reference

- ä¸¾ä¸ª ğŸŒ° :

```js
var foo = 1;

// å¯¹åº”çš„Referenceæ˜¯ï¼š
var fooReference = {
  base: EnvironmentRecord,
  name: 'foo',
  strict: false
};
```

### 4.2 è§„èŒƒä¸­è¿˜æä¾›äº†è·å– Reference ç»„æˆéƒ¨åˆ†çš„æ–¹æ³•ï¼Œæ¯”å¦‚ GetBase å’Œ IsPropertyReferenceã€‚

- GetValue è¿”å›å¯¹è±¡å±æ€§çœŸæ­£çš„å€¼ï¼Œä½†æ˜¯è¦é‡ç‚¹æ³¨æ„ï¼š
  **è°ƒç”¨ GetValueï¼Œè¿”å›çš„å°†æ˜¯å…·ä½“çš„å€¼ï¼Œè€Œä¸å†æ˜¯ä¸€ä¸ª Reference**
- IsPropertyReference å¦‚æœ base value æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå°±è¿”å› true

### åˆ¤æ–­ this æŒ‡å‘

1. æ‰¾åˆ°æ˜¯è°è°ƒç”¨(MemberExpression) ç¤ºä¾‹:

```js
function foo() {
  console.log(this);
}

foo(); // MemberExpression æ˜¯ foo

function foo() {
  return function() {
    console.log(this);
  };
}

foo()(); // MemberExpression æ˜¯ foo()

var foo = {
  bar: function() {
    return this;
  }
};

foo.bar(); // MemberExpression æ˜¯ foo.bar

//å…¶å®ç®€å•ç†è§£ MemberExpression å…¶å®å°±æ˜¯()å·¦è¾¹çš„éƒ¨åˆ†ã€‚
```

2. åˆ¤æ–­ ref æ˜¯ä¸æ˜¯ä¸€ä¸ª Reference ç±»å‹ã€‚
   å…³é”®å°±åœ¨äºçœ‹è§„èŒƒæ˜¯å¦‚ä½•å¤„ç†å„ç§ MemberExpressionï¼Œè¿”å›çš„ç»“æœæ˜¯ä¸æ˜¯ä¸€ä¸ª Reference ç±»å‹(è¯­è¨€ç±»å‹)ã€‚

å®æˆ˜:

```js
var value = 1;

var foo = {
  value: 2,
  bar: function() {
    return this.value;
  }
};

//ç¤ºä¾‹1
console.log(foo.bar());
//ç¤ºä¾‹2
console.log(foo.bar());
//ç¤ºä¾‹3
console.log((foo.bar = foo.bar)());
//ç¤ºä¾‹4
console.log((false || foo.bar)());
//ç¤ºä¾‹5
console.log((foo.bar, foo.bar)());
```

### foo.bar()

```js
var Reference = {
  base: foo,
  name: 'bar',
  strict: false
};

/*
 * ç¬¬ä¸€æ­¥,æ‰¾åˆ° MemberExpression,æ˜¯ foo.bar,æ˜¯ Reference
 * ç¬¬äºŒæ­¥,base value ä¸º fooï¼Œæ˜¯ä¸€ä¸ªå¯¹è±¡;æ‰§è¡Œ IsPropertyReference(ref),ä¸º true;
 * ç¬¬ä¸‰æ­¥, base value å€¼ï¼Œè¿™ä¸ªä¾‹å­ä¸­å°±æ˜¯ foo,æ‰€ä»¥ this çš„å€¼å°±æ˜¯ foo ï¼Œç¤ºä¾‹ 1 çš„ç»“æœå°±æ˜¯ 2ï¼
 */
```

### (foo.bar)()

```js
var Reference = {
  base: foo,
  name: 'bar',
  strict: false
};

/*
 * ç¬¬ä¸€æ­¥,æ‰¾åˆ° MemberExpression,æ˜¯ foo.bar,æ˜¯ Reference
 * ç¬¬äºŒæ­¥,base value ä¸º fooï¼Œæ˜¯ä¸€ä¸ªå¯¹è±¡;æ‰§è¡Œ IsPropertyReference(ref),ä¸º true;
 * ç¬¬ä¸‰æ­¥, base value å€¼ï¼Œè¿™ä¸ªä¾‹å­ä¸­å°±æ˜¯ foo,æ‰€ä»¥ this çš„å€¼å°±æ˜¯ foo ï¼Œç¤ºä¾‹ 2 çš„ç»“æœå°±æ˜¯ 2ï¼
 */
```

### (foo.bar = foo.bar)()

```js
var Reference = {
  base: foo,
  name: 'bar',
  strict: false
};

/*
 * ç¬¬ä¸€æ­¥,æ‰¾åˆ° MemberExpression,æœ‰èµ‹å€¼æ“ä½œç¬¦ = ,ä¹Ÿå°±æ˜¯ä½¿ç”¨äº†GetValueï¼Œæ‰€ä»¥è¿”å›çš„å€¼ä¸æ˜¯ Reference ç±»å‹
 * ç¬¬äºŒæ­¥,å¦‚æœ ref ä¸æ˜¯Referenceï¼Œé‚£ä¹ˆ this çš„å€¼ä¸º undefined
 * ç¬¬ä¸‰æ­¥,this ä¸º undefinedï¼Œéä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œthis çš„å€¼ä¸º undefined çš„æ—¶å€™ï¼Œå…¶å€¼ä¼šè¢«éšå¼è½¬æ¢ä¸ºå…¨å±€å¯¹è±¡,ä¹Ÿå°±æ˜¯windowå¯¹è±¡ã€‚ä¸¥æ ¼æ¨¡å¼ä¸‹å°±æ˜¯undefined
 */
```

### (false || foo.bar)()

```js
// é€»è¾‘ä¸ç®—æ³•,ä½¿ç”¨äº† GetValueï¼Œæ‰€ä»¥è¿”å›çš„ä¸æ˜¯ Reference ç±»å‹ï¼Œthis ä¸º undefined
```

### (foo.bar, foo.bar)()

```js
// é€—å·æ“ä½œç¬¦,ä½¿ç”¨äº† GetValueï¼Œæ‰€ä»¥è¿”å›çš„ä¸æ˜¯ Reference ç±»å‹ï¼Œthis ä¸º undefined
```

æœ€åç»“æœ:

```js
var value = 1;

var foo = {
  value: 2,
  bar: function() {
    return this.value;
  }
};

//ç¤ºä¾‹1
console.log(foo.bar()); // 2
//ç¤ºä¾‹2
console.log(foo.bar()); // 2
//ç¤ºä¾‹3
console.log((foo.bar = foo.bar)()); // 1
//ç¤ºä¾‹4
console.log((false || foo.bar)()); // 1
//ç¤ºä¾‹5
console.log((foo.bar, foo.bar)()); // 1
```

æ³¨æ„ï¼šä»¥ä¸Šæ˜¯åœ¨éä¸¥æ ¼æ¨¡å¼ä¸‹çš„ç»“æœï¼Œä¸¥æ ¼æ¨¡å¼ä¸‹å› ä¸º this è¿”å› undefinedï¼Œæ‰€ä»¥ç¤ºä¾‹ 3 ä¼šæŠ¥é”™ã€‚
